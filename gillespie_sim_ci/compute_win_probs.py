import pandas as pd
import numpy as np
import multiprocessing as mp
from subprocess import call
import sys
sys.path.append('../')
from package_global_functions import *

extSSDpath = getExternalSSDpath()
if os.path.exists(extSSDpath):
    resPath = extSSDpath + getProjectFoldername() + '/gillespie_sim_ci/results'
else:
    resPath = '/results'
    print('Forgot the SSD!!!!!')

def get_win_probs(pis, qs, l, lci, ci_kwargs, N, maxTime, Nrea, ic, mpID):
    pichain_exec = ','.join([str(pi) for pi in pis]) 
    qchain_exec = ','.join([str(q) for q in qs]) 
    ci_kwargs_chainExec = ','.join([str(cikw) for cikw in ci_kwargs])
    print(f'getting win probs from {l}, {ci_kwargs}')
    call(f'python LES_model_Gill_autoStop.py -pis {pichain_exec} -qs {qchain_exec} -l {l} -lci {lci} -N {N} -maxTime {maxTime} -Nrea {Nrea} -ic {ic} -ci_kwargs {ci_kwargs_chainExec} > winprobs{mpID}.dat', shell=True)
    with open(f'winprobs{mpID}.dat', 'r') as file:
        winprobs = [float(f)/Nrea for f in file.readline().split()]
    return winprobs

paramCombs = [
    # sample line
    # [(0.1, 0.1), (9.0, 10.0), 0.1, 1.0, (2, 0.3, 500.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.1, 1.0,  (1, 0.3, 500.0), 1000, 75.0, 1000, 'N'],

    # will have to be repeated with Nrea = 10000...
    # [(0.1, 0.1), (9.0, 10.0), 0.1, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.15, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.2, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.3, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.45, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.6, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.75, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.9, 1.0, (1, 0.3, 15.0), 1000, 100.0, 10000, 'N'],

    # [(0.1, 0.1), (9.0, 10.0), 0.1, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.15, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.2, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.3, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.45, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.75, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.9, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],

    # repeat with 10000 rea?
    # [(0.1, 0.1), (5.0, 10.0), 0.1, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.2, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.3, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.45, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.75, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (5.0, 10.0), 0.9, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.1, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.2, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.3, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.45, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.75, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (8.0, 10.0), 0.9, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.1, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.2, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.3, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.45, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.75, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.5, 10.0), 0.9, 1.0, (1, 0.333, 20.0), 1000, 100.0, 1000, 'N'],

    # [(0.15, 0.15), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.2, 0.2), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.25, 0.25), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.3, 0.3), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.35, 0.35), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],
    # [(0.4, 0.4), (9.0, 10.0), 0.6, 1.0, (1, 0.333, 20.0), 1000, 100.0, 10000, 'N'],

    [(0.35, 0.35), (9.0, 10.0), 0.6, 1.0, (0, ), 1000, 100.0, 10000, 'N'],



    # [(0.1, 0.1), (9.0, 10.0), 0.1, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.15, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.2, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.3, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.45, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.6, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.75, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.9, 1.0, (2, 0.3, 15.0), 1000, 100.0, 1000, 'N'],

    # [(0.1, 0.1), (9.0, 10.0), 0.1, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.15, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.2, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.3, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.45, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.6, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.75, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1), (9.0, 10.0), 0.9, 1.0, (2, 0.3, 20.0), 1000, 100.0, 1000, 'N'],

    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.1, 1.0,  (2, 0.3, 10.0), 1000, 150.0, 1000, 'N'], 
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.2, 1.0,  (2, 0.3, 10.0), 1000, 100.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.3, 1.0,  (2, 0.3, 10.0), 1000, 80.0, 1000, 'N'], 
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.45, 1.0,  (2, 0.3, 10.0), 1000, 70.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.6, 1.0,  (2, 0.3, 10.0), 1000, 60.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.75, 1.0,  (2, 0.3, 10.0), 1000, 50.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.9, 1.0,  (2, 0.3, 10.0), 1000, 45.0, 1000, 'N'],

    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.1, 1.0,  (1, 0.5, 10.0), 1000, 80.0, 1000, 'N'], 
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.2, 1.0,  (1, 0.5, 10.0), 1000, 120.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.3, 1.0,  (1, 0.5, 10.0), 1000, 90.0, 1000, 'N'], 
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.45, 1.0,  (1, 0.5, 10.0), 1000, 70.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.6, 1.0,  (1, 0.5, 10.0), 1000, 60.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.75, 1.0,  (1, 0.5, 10.0), 1000, 50.0, 1000, 'N'],
    # [(0.1, 0.1, 0.1), (8.0, 9.0, 10.0), 0.9, 1.0,  (1, 0.5, 10.0), 1000, 45.0, 1000, 'N'],

    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.1, 1.0,  (1, 0.2, 500.0), 1000, 45.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.2, 1.0,  (1, 0.2, 500.0), 1000, 45.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.3, 1.0,  (1, 0.2, 500.0), 1000, 45.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.45, 1.0,  (1, 0.2, 500.0), 1000, 40.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.6, 1.0,  (1, 0.2, 500.0), 1000, 35.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.75, 1.0,  (1, 0.2, 500.0), 1000, 30.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.9, 1.0,  (1, 0.2, 500.0), 1000, 30.0, 1000, 'N'],

    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.1, 1.0,  (2, 0.2, 500.0), 1000, 65.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.2, 1.0,  (2, 0.2, 500.0), 1000, 65.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.3, 1.0,  (2, 0.2, 500.0), 1000, 65.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.45, 1.0,  (2, 0.2, 500.0), 1000, 60.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.6, 1.0,  (2, 0.2, 500.0), 1000, 45.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.75, 1.0,  (2, 0.2, 500.0), 1000, 40.0, 1000, 'N'],
    # [(0.075, 0.075, 0.075, 0.075), (7.0, 8.0, 9.0, 10.0), 0.9, 1.0,  (2, 0.2, 500.0), 1000, 40.0, 1000, 'N'],

    
]

# this happened for pis 0.1,0.1 qs 8.0,10.0; the probabilities of f1,f2 winning are correct (at the moment the sim is stopped they are indeed winning)
# but as I want to estimate the probability of arriving at the particular fixed point, i set to 0.0,1.0 these last columns in the df
# 0.1,0.1,8.0,10.0,0.1,1.0,"(0,)",1000,N,10000,0.4622,0.5378
# 0.1,0.1,8.0,10.0,0.2,1.0,"(0,)",1000,N,10000,0.5046,0.4954
# 0.1,0.1,8.0,10.0,0.3,1.0,"(0,)",1000,N,10000,0.5014,0.4986

# nose perque son 100 Nrea...
# 0.2,0.2,9.0,10.0,0.1,1.0,"(1, 0.5, 10.0)",1000,N,100,0.22,0.78
# 0.2,0.2,9.0,10.0,0.15,1.0,"(1, 0.5, 10.0)",1000,N,100,0.25,0.75
# 0.2,0.2,9.0,10.0,0.2,1.0,"(1, 0.5, 10.0)",1000,N,100,0.25,0.75
# 0.2,0.2,9.0,10.0,0.3,1.0,"(1, 0.5, 10.0)",1000,N,100,0.3,0.7
# 0.2,0.2,9.0,10.0,0.45,1.0,"(1, 0.5, 10.0)",1000,N,100,0.37,0.63
# 0.2,0.2,9.0,10.0,0.6,1.0,"(1, 0.5, 10.0)",1000,N,100,0.48,0.52
# 0.2,0.2,9.0,10.0,0.75,1.0,"(1, 0.5, 10.0)",1000,N,100,0.42,0.58
# 0.2,0.2,9.0,10.0,0.9,1.0,"(1, 0.5, 10.0)",1000,N,100,0.4,0.6

# save data while i repeat sims
# 0.15,0.15,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.428,0.572
# 0.2,0.2,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.406,0.594
# 0.25,0.25,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.427,0.573
# 0.3,0.3,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.431,0.569
# 0.35,0.35,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.448,0.552
# 0.4,0.4,9.0,10.0,0.6,1.0,"(1, 0.333, 20.0)",1000,N,1000,0.419,0.581

if __name__ == '__main__':
    pool = mp.Pool(int(mp.cpu_count()/2))
    # pool = mp.Pool(1)
    res_async = [pool.apply_async(get_win_probs, args = (*paramComb, i)) for i,paramComb in enumerate(paramCombs)]
    allwinprobs = [r.get() for r in res_async]
    # pi1s, pi2s, q1s, q2s, ls, lcis, ci_kwargs_list, Ns, maxTimes, Nreas, ics, winf1, winf2 = [], [],  [], [], [], [], [], [], [], [], [], [], [],
    # for winprobs,paramComb in zip(allwinprobs,paramCombs):
    #     pi1s.append(paramComb[0][0]), pi2s.append(paramComb[0][1]), q1s.append(paramComb[1][0]), q2s.append(paramComb[1][1])
    #     ls.append(paramComb[2]), lcis.append(paramComb[3]), ci_kwargs_list.append(paramComb[4]), Ns.append(paramComb[5])
    #     maxTimes.append(paramComb[6]), Nreas.append(paramComb[7]), ics.append(paramComb[8])
    #     winf1.append(winprobs[0]), winf2.append(winprobs[1])
    # pool.close()
    # call('rm winprobs*.dat', shell=True)
    # dfwinf_new = pd.DataFrame({'pi1':pi1s, 'pi2':pi2s, 'q1':q1s, 'q2':q2s, 'l': ls, 
    #                    'lci':lcis, 'ci_kwargs':ci_kwargs_list, 'N':Ns, 'ic':ics, 'Nrea':Nreas,
    #                      'f1win':winf1, 'f2win':winf2})
    # dfwinf = pd.read_csv(f'{resPath}/winner_perc_data.csv')
    # dfwinf = pd.concat([dfwinf, dfwinf_new], ignore_index=True)
    # dfwinf = dfwinf.sort_values(by=['pi1', 'pi2', 'q1', 'q2', 'ci_kwargs', 'l', 'lci',  'N', 'Nrea'], ignore_index=True)
    # dfwinf.to_csv(f'{resPath}/winner_perc_data.csv', index=False)

    Nsites = len(paramCombs[0][0])
    pis, qs, winf = [[] for i in range(Nsites)], [[] for i in range(Nsites)], [[] for i in range(Nsites)]
    ls, lcis, ci_kwargs_list, Ns, maxTimes, Nreas, ics, maxTimes = [], [], [], [], [], [], [], []
    for winprobs,paramComb in zip(allwinprobs,paramCombs):
        for i in range(Nsites):
            pis[i].append(paramComb[0][i]), qs[i].append(paramComb[1][i]), winf[i].append(winprobs[i])
        ls.append(paramComb[2]), lcis.append(paramComb[3]), ci_kwargs_list.append(paramComb[4]), Ns.append(paramComb[5])
        maxTimes.append(paramComb[6]), Nreas.append(paramComb[7]), ics.append(paramComb[8])
    pool.close()
    call('rm winprobs*.dat', shell=True)
    dic_winf = {}
    for i in range(Nsites):
        dic_winf[f'pi{i+1}'] = pis[i]
    for i in range(Nsites):
        dic_winf[f'q{i+1}'] = qs[i]
    dic_winf['l'] = ls
    dic_winf['lci'] = lcis
    dic_winf['ci_kwargs'] = ci_kwargs_list
    dic_winf['N'] = Ns
    dic_winf['ic'] = ics
    dic_winf['Nrea'] = Nreas
    if Nsites > 2:
        dic_winf['maxTime'] = maxTimes
    for i in range(Nsites):
        dic_winf[f'f{i+1}'] = winf[i]
    dfwinf_new = pd.DataFrame(dic_winf)
    sitesSufix = f'_{Nsites}_sites' if Nsites > 2 else ''
    winnerDataFileName = f'winner_perc_data{sitesSufix}.csv'
    if os.path.exists(f'{resPath}/{winnerDataFileName}'):
        dfwinf = pd.read_csv(f'{resPath}/{winnerDataFileName}')
        dfwinf = pd.concat([dfwinf, dfwinf_new], ignore_index=True)
        sortValsBy = [f'pi{i+1}' for i in range(Nsites)]
        sortValsBy.extend([f'q{i+1}' for i in range(Nsites)])
        sortValsBy.extend(['ci_kwargs', 'l', 'lci',  'N', 'Nrea'])
        dfwinf = dfwinf.sort_values(by=sortValsBy, ignore_index=True)
        dfwinf.to_csv(f'{resPath}/{winnerDataFileName}', index=False)
    else:
        dfwinf_new.to_csv(f'{resPath}/{winnerDataFileName}', index=False)